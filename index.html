<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブロックサプライズ コミュニティ</title>
  <style>
    body { font-family:"Noto Serif JP",serif; background:#f7f3eb; margin:0; }
    header { display:flex; justify-content:space-between; align-items:center;
      padding:12px 20px; background:#fff; border-bottom:1px solid #ddd; position:sticky; top:0; }
    header h1 { margin:0; color:#3a2f2f; font-size:1.2rem; }
    #logoutBtn { background:#3a2f2f; color:#fff; border:none; border-radius:6px; padding:8px 14px; cursor:pointer; font-weight:600; }
    main { max-width:860px; margin:0 auto; padding:20px; }
    .post { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); padding:12px; margin:12px 0; }
    .meta { font-size:.9rem; color:#777; margin-bottom:6px; }
    .nick { font-weight:bold; color:#3a2f2f; }
    .hidden { display:none !important; }
    #postToggle { position:fixed; right:20px; bottom:20px; background:#3a2f2f; color:#fff; border:none; border-radius:24px;
      padding:12px 18px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.2); cursor:pointer; }
    #postBar { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #ddd; padding:10px; }
    #postForm { display:flex; gap:8px; }
    #postInput { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
    #postForm button { background:#3a2f2f; color:#fff; border:none; border-radius:8px; padding:10px 16px; cursor:pointer; }
  </style>
</head>
<body>
  <header>
    <h1>ブロックサプライズ コミュニティ</h1>
    <button id="logoutBtn" class="hidden">ログアウト</button>
  </header>

  <main>
    <div id="posts"></div>
  </main>

  <button id="postToggle">＋ 投稿</button>

  <div id="postBar" class="hidden">
    <form id="postForm">
      <input id="postInput" type="text" maxlength="500" placeholder="投稿内容…" />
      <button type="submit">送信</button>
    </form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, getDoc, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDe-uSTjbvc_I51iB5d5MH8byG8ATQmRa0",
      authDomain: "block-surprise-community.firebaseapp.com",
      projectId: "block-surprise-community",
      storageBucket: "block-surprise-community.firebasestorage.app",
      messagingSenderId: "734221997168",
      appId: "1:734221997168:web:3ea9659c4b140704d610b5",
      measurementId: "G-V5G9WVG3Z0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // NGワード判定（Firestoreから取得）
    async function loadNgWords() {
      const snap = await getDocs(collection(db, "ngWords"));
      return snap.docs.map(doc => doc.data().word);
    }
    async function containsNgWord(text) {
      const ngWords = await loadNgWords();
      return ngWords.some(word => text.includes(word));
    }

    // 投稿読み込み
    async function loadPosts(){
      const postsDiv = document.getElementById("posts");
      postsDiv.innerHTML="";
      const q = query(collection(db,"communityPosts"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(q);
      snap.forEach(docu=>{
        const d = docu.data();
        const time = d.createdAt?.toDate?.() ? d.createdAt.toDate().toLocaleString() : "";
        const isMine = localStorage.getItem("profileUid") === d.userId;
        if (d.hidden && !isMine) return; // 他人には非表示
        postsDiv.innerHTML += `
          <div class="post">
            <div class="meta"><span class="nick">${d.nickname||"匿名"}</span>・${time}</div>
            <div class="text">${d.text||""}</div>
          </div>`;
      });
    }
    loadPosts();

    // 投稿処理
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!auth.currentUser) await signInAnonymously(auth);

      const text = postInput.value.trim();
      if (!text) return;

      const profUid = localStorage.getItem("profileUid") || auth.currentUser.uid;
      const udoc = await getDoc(doc(db,"users", profUid));
      const nickname = udoc.exists()? (udoc.data().nickname || "匿名") : "匿名";

      const isToxic = await containsNgWord(text);

      await addDoc(collection(db,"communityPosts"), {
        userId: profUid,
        authUid: auth.currentUser.uid,
        nickname,
        text,
        createdAt: serverTimestamp(),
        hidden: isToxic
      });

      postInput.value = "";
      loadPosts();
    });

    // 投稿バー表示切替
    postToggle.addEventListener("click", () => {
      postBar.classList.toggle("hidden");
    });

    // ログアウト処理
    logoutBtn.addEventListener("click", async () => {
      localStorage.removeItem("profileUid");
      logoutBtn.classList.add("hidden");
      await signOut(auth);
      alert("ログアウトしました");
    });
  </script>
</body>
</html>

