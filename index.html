<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブロックサプライズ コミュニティ</title>
  <style>
    body { font-family: "Noto Serif JP", serif; background:#f7f3eb; margin:0; padding:0; }
    main { max-width:860px; margin:0 auto; padding:20px; }
    h1 { margin:0 0 12px; color:#3a2f2f; }
    .post { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.08);
            padding:12px; margin:12px 0; }
    .meta { font-size:.9rem; color:#777; margin-bottom:6px; }
    .nick { font-weight:bold; color:#3a2f2f; }
    .hidden { display:none; }
    /* 投稿ボタン */
    #postToggle {
      position:fixed; right:20px; bottom:20px;
      background:#3a2f2f; color:#fff; border:none; border-radius:24px;
      padding:12px 18px; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,.2);
    }
    /* 投稿バー */
    #postBar {
      position:fixed; left:0; right:0; bottom:0;
      background:#fff; border-top:1px solid #ddd; padding:10px;
    }
    #postForm { display:flex; gap:8px; }
    #postInput { flex:1; padding:10px; border-radius:8px; border:1px solid #ccc; }
    #postForm button { background:#3a2f2f; color:#fff; border:none; border-radius:8px; padding:10px 16px; }
    /* ログインフォーム */
    #authModal {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center;
    }
    #authBox {
      background:#fff; border-radius:12px; padding:20px; max-width:360px; width:90%;
    }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input { width:100%; padding:8px; border-radius:8px; border:1px solid #ccc; }
    button.authBtn { margin-top:10px; width:100%; }
  </style>
</head>
<body>
  <main>
    <h1>最新の投稿</h1>
    <div id="posts"></div>
  </main>

  <!-- 投稿ボタン -->
  <button id="postToggle">＋ 投稿</button>

  <!-- 投稿バー -->
  <div id="postBar" class="hidden">
    <form id="postForm">
      <input id="postInput" type="text" placeholder="投稿内容…" />
      <button type="submit">送信</button>
    </form>
  </div>

  <!-- ログイン／登録モーダル -->
  <div id="authModal" class="hidden">
    <div id="authBox">
      <h2>ログイン / 新規登録</h2>
      <form id="registerForm">
        <label for="regEmail">メール</label>
        <input id="regEmail" type="email" required />
        <label for="regPassword">パスワード</label>
        <input id="regPassword" type="password" required />
        <label for="regNickname">ニックネーム</label>
        <input id="regNickname" type="text" required />
        <button class="authBtn" type="submit">登録</button>
      </form>
      <form id="loginForm" style="margin-top:12px;">
        <label for="logEmail">メール</label>
        <input id="logEmail" type="email" required />
        <label for="logPassword">パスワード</label>
        <input id="logPassword" type="password" required />
        <button class="authBtn" type="submit">ログイン</button>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } 
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, setDoc, getDoc } 
      from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDe-uSTjbvc_I51iB5d5MH8byG8ATQmRa0",
      authDomain: "block-surprise-community.firebaseapp.com",
      projectId: "block-surprise-community",
      storageBucket: "block-surprise-community.firebasestorage.app",
      messagingSenderId: "734221997168",
      appId: "1:734221997168:web:3ea9659c4b140704d610b5",
      measurementId: "G-V5G9WVG3Z0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const postsDiv = document.getElementById("posts");
    const postToggle = document.getElementById("postToggle");
    const postBar = document.getElementById("postBar");
    const postForm = document.getElementById("postForm");
    const postInput = document.getElementById("postInput");
    const authModal = document.getElementById("authModal");
    const registerForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");

    // URLをリンク化
    function linkify(text) {
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return escapeHtml(text).replace(urlRegex, url => `<a href="${url}" target="_blank">${url}</a>`);
    }
    function escapeHtml(str) {
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;")
        .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }

    // 投稿一覧ロード
    async function loadPosts() {
      postsDiv.innerHTML = "";
      const q = query(collection(db,"communityPosts"), orderBy("createdAt","desc"));
      const snap = await getDocs(q);
      snap.forEach(docu => {
        const d = docu.data();
        const time = d.createdAt?.toDate?.().toLocaleString() || "";
        postsDiv.innerHTML += `
          <div class="post">
            <div class="meta"><span class="nick">${escapeHtml(d.nickname||"匿名")}</span>・${time}</div>
            <div class="text">${linkify(d.text||"")}</div>
          </div>`;
      });
    }
    loadPosts();

    // 投稿ボタン
    postToggle.addEventListener("click", () => {
      postBar.classList.toggle("hidden");
    });

    // 投稿処理
    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) { authModal.classList.remove("hidden"); return; }
      const text = postInput.value.trim();
      if (!text) return;
      const udoc = await getDoc(doc(db,"users",user.uid));
      const nickname = udoc.exists()? udoc.data().nickname : "匿名";
      await addDoc(collection(db,"communityPosts"), {
        userId:user.uid, nickname, text, createdAt:serverTimestamp()
      });
      postInput.value="";
      loadPosts();
    });

    // 登録
    registerForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email = document.getElementById("regEmail").value;
      const pass = document.getElementById("regPassword").value;
      const nick = document.getElementById("regNickname").value;
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      await setDoc(doc(db,"users",cred.user.uid),{nickname:nick,createdAt:serverTimestamp()});
      authModal.classList.add("hidden");
    });

    // ログイン
    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const email =
