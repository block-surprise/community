  <header>
    <h1>ãƒ–ãƒ­ãƒƒã‚¯ã‚µãƒ—ãƒ©ã‚¤ã‚º ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£</h1>
    <button id="logoutBtn" class="hidden">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <main>
    <div id="posts"></div>
  </main>

  <button id="postToggle">ï¼‹ æŠ•ç¨¿</button>

  <div id="postBar" class="hidden">
    <form id="postForm">
      <input id="postInput" type="text" maxlength="500" placeholder="æŠ•ç¨¿å†…å®¹â€¦" />
      <button type="submit">é€ä¿¡</button>
    </form>
  </div>

  <div id="authModal" class="hidden">
    <div id="authBox">
      <h2>ãƒ­ã‚°ã‚¤ãƒ³</h2>
      <form id="loginForm">
        <label for="logUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label>
        <input id="logUsername" type="text" required />
        <label for="logPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="logPassword" type="password" required />
        <button class="authBtn" type="submit">ãƒ­ã‚°ã‚¤ãƒ³</button>
        <div id="loginStatus" class="status"></div>
      </form>

      <div class="link" id="showRegister">ã¾ã ç™»éŒ²ã—ã¦ã„ãªã„æ–¹ã¯ã“ã¡ã‚‰</div>

      <form id="registerForm" class="hidden">
        <h2>æ–°è¦ç™»éŒ²</h2>
        <label for="regUsername">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </label>
        <input id="regUsername" type="text" maxlength="32" required />
        <span id="usernameStatus"></span>
        <label for="regNickname">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </label>
        <input id="regNickname" type="text" maxlength="32" required />
        <label for="regPassword">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input id="regPassword" type="password" required />
        <button class="authBtn" type="submit">ç™»éŒ²</button>
        <div id="registerStatus" class="status"></div>
      </form>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, getDoc, where, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDe-uSTjbvc_I51iB5d5MH8byG8ATQmRa0",
      authDomain: "block-surprise-community.firebaseapp.com",
      projectId: "block-surprise-community",
      storageBucket: "block-surprise-community.firebasestorage.app",
      messagingSenderId: "734221997168",
      appId: "1:734221997168:web:3ea9659c4b140704d610b5",
      measurementId: "G-V5G9WVG3Z0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);


    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function escapeHtml(str){
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#39;");
    }
    function linkify(text){
      const safe = escapeHtml(text);
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      return safe.replace(urlRegex, (m)=>`<a href="${m}" target="_blank" rel="noopener">${m}</a>`);
    }
    async function hashPassword(pw){
      const enc = new TextEncoder().encode(pw);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
    const SESSION_KEY = "profileUid";
    function getProfileUid(){ return localStorage.getItem(SESSION_KEY); }
    function setProfileUid(uid){ localStorage.setItem(SESSION_KEY, uid); }
    function clearProfileUid(){ localStorage.removeItem(SESSION_KEY); }

    // æŠ•ç¨¿èª­ã¿è¾¼ã¿
    async function loadPosts(){
      const postsDiv = document.getElementById("posts");
      postsDiv.innerHTML="";
      const q = query(collection(db,"communityPosts"), orderBy("createdAt","desc"), limit(50));
      const snap = await getDocs(q);
      snap.forEach(docu=>{
        const d = docu.data();
        const time = d.createdAt?.toDate?.() ? d.createdAt.toDate().toLocaleString() : "";
        postsDiv.innerHTML += `
          <div class="post">
            <div class="meta"><span class="nick">${escapeHtml(d.nickname||"åŒ¿å")}</span>ãƒ»${escapeHtml(time)}</div>
            <div class="text">${linkify(d.text||"")}</div>
          </div>`;
      });
    }
    loadPosts();

    // æŠ•ç¨¿ãƒãƒ¼è¡¨ç¤ºåˆ‡æ›¿
    postToggle.addEventListener("click", () => {
      postBar.classList.toggle("hidden");
    });

// æŠ•ç¨¿å‡¦ç†
postForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  console.log("æŠ•ç¨¿ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«");

  if (!auth.currentUser) {
    await signInAnonymously(auth);
  }
  const profUid = getProfileUid();
  if (!profUid) {
    authModal.classList.remove("hidden");
    loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚";
    return;
  }
  const text = postInput.value.trim();
  if (!text) return;

  try {
    const udoc = await getDoc(doc(db,"users", profUid));
    const nickname = udoc.exists()? (udoc.data().nickname || "åŒ¿å") : "åŒ¿å";

    // ğŸ” NGãƒ¯ãƒ¼ãƒ‰åˆ¤å®š
    const isToxic = await containsNgWord(text);

    // Firestoreã«ä¿å­˜ï¼ˆhiddenãƒ•ãƒ©ã‚°ä»˜ãï¼‰
    await addDoc(collection(db,"communityPosts"), {
      userId: profUid,
      authUid: auth.currentUser.uid,
      nickname,
      text,
      createdAt: serverTimestamp(),
      hidden: isToxic // â† NGãƒ¯ãƒ¼ãƒ‰ãªã‚‰ true
    });

    postInput.value = "";
    loadPosts();
  } catch (err) {
    alert("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: " + (err.code || err.message));
  }
});


    // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    showRegister.addEventListener("click", ()=>{
      registerForm.classList.remove("hidden");
      showRegister.classList.add("hidden");
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ é‡è¤‡ãƒã‚§ãƒƒã‚¯
    regUsername.addEventListener("input", async () => {
      const uname = regUsername.value.trim();
      usernameStatus.textContent = "";
      if (!uname) return;
      const q = query(collection(db, "users"), where("username", "==", uname));
      const snap = await getDocs(q);
      if (snap.empty) {
        usernameStatus.textContent = "âœ”ï¸"; usernameStatus.style.color = "green";
      } else {
        usernameStatus.textContent = "âœ–ï¸"; usernameStatus.style.color = "red";
      }
    });

    // æ–°è¦ç™»éŒ²
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      registerStatus.textContent = "ç™»éŒ²ä¸­â€¦";

      const username = document.getElementById("regUsername").value.trim();
      const nickname = document.getElementById("regNickname").value.trim();
      const password = document.getElementById("regPassword").value;

      if (!username || !nickname || !password) {
        registerStatus.classList.add("error");
        registerStatus.textContent = "æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚";
        return;
      }

      const dupQ = query(collection(db, "users"), where("username", "==", username));
      const dupSnap = await getDocs(dupQ);
      if (!dupSnap.empty) {
        registerStatus.classList.add("error");
        registerStatus.textContent = "ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚";
        return;
      }

      try {
        if (!auth.currentUser) {
          await signInAnonymously(auth);
        }
        const passwordHash = await hashPassword(password);

        const profileDocRef = await addDoc(collection(db, "users"), {
          username,
          nickname,
          passwordHash,
          authUid: auth.currentUser.uid, // åŒ¿åUIDã‚’ç´ä»˜ã‘
          createdAt: serverTimestamp()
        });

        setProfileUid(profileDocRef.id);
        registerStatus.classList.add("ok");
        registerStatus.textContent = "ç™»éŒ²å®Œäº†ã€‚ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™ã€‚";
        authModal.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } catch (err) {
        registerStatus.classList.add("error");
        registerStatus.textContent = `ç™»éŒ²å¤±æ•—: ${err.code || err.message}`;
      }
    });

    // ãƒ­ã‚°ã‚¤ãƒ³
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginStatus.textContent = "èªè¨¼ä¸­â€¦";
      const uname = document.getElementById("logUsername").value.trim();
      const pass = document.getElementById("logPassword").value;

      if (!uname || !pass) {
        loginStatus.classList.add("error");
        loginStatus.textContent = "æœªå…¥åŠ›ã®é …ç›®ãŒã‚ã‚Šã¾ã™ã€‚";
        return;
      }

      try {
        if (!auth.currentUser) {
          await signInAnonymously(auth);
        }
        const qy = query(collection(db,"users"), where("username","==",uname), limit(1));
        const snap = await getDocs(qy);
        if (snap.empty) {
          loginStatus.classList.add("error");
          loginStatus.textContent = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
          return;
        }
        const docu = snap.docs[0];
        const data = docu.data();
        const inputHash = await hashPassword(pass);

        if (data.passwordHash !== inputHash) {
          loginStatus.classList.add("error");
          loginStatus.textContent = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚";
          return;
        }

        setProfileUid(docu.id);
        loginStatus.classList.add("ok");
        loginStatus.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸã€‚";
        authModal.classList.add("hidden");
        logoutBtn.classList.remove("hidden");
      } catch (err) {
        loginStatus.classList.add("error");
        loginStatus.textContent = `ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—: ${err.code || err.message}`;
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    logoutBtn.addEventListener("click", async () => {
      clearProfileUid();
      logoutBtn.classList.add("hidden");
      await signOut(auth);
      alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚");
    });

    if (getProfileUid()) { logoutBtn.classList.remove("hidden"); }
  </script>
  <script>
    <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAuth, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, getDocs, doc, getDoc, where, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = { ... };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ğŸ” NGãƒ¯ãƒ¼ãƒ‰åˆ¤å®šã®ä»®é–¢æ•°
  async function containsNgWord(text){ return false; }

  let pressTimer;
  const title = document.getElementById("title");
  const logoutBtn = document.getElementById("logoutBtn");

  // ã‚¿ã‚¤ãƒˆãƒ«ã‚’é•·æŠ¼ã—ã™ã‚‹ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ãŒå‡ºã‚‹
  title.addEventListener("mousedown", () => {
    pressTimer = setTimeout(() => {
      logoutBtn.classList.remove("hidden");
    }, 3000);
  });
  title.addEventListener("mouseup", () => {
    clearTimeout(pressTimer);
  });

  // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    clearProfileUid();
    logoutBtn.classList.add("hidden");
    document.getElementById("posts").innerHTML = "";
    alert("ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ");
  });

  </script>
</body>
</html>
